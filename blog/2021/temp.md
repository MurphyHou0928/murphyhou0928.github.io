# Ⅵ、8259A

``` 
中断控制器的功能：
    接收外部的中断请求，进行判断，选中优先级最高的中断请求，送到CPU的INTR端；CPU响应中断进入中断子程序时，负责对外部中断请求管理，可实现中断嵌套。

8259A的工作特点： 

    ① 能管理8级中断，可与其它8个8259A芯片组成主从式中断系统，实现64级中断源控制；

    ② 可编程使用，非常灵活；

    ③ 只需一组5V电源。
```

## 1.外部信号和含义

```

① D7～D0 数据线：在系统中，他们和数据总线相连

② INT 中断请求信号：和CPU的INTR端相连，向CPU发送中断请求

③ INTA# 中断应答信号：接收来自CPU的中断应答信号，如果CPU接收到中断请求信号，而此时中断允许位标志为1，并且正好一条指令执行完毕，那么在当前总线周期和下一个总线周期中，CPU将在/TNTA引脚上分别分发一个负脉冲作为中断响应信号，在第二个/INTA脉冲结束时，CPU读取8259A送到数据总线上的中断类型号

④ RD# 读出信号：将8259A某个内部寄存器的内容送达数据总线

⑤ WR# 写入信号：使8259A从数据总线上接收数据

⑥ CS# 片选信号

⑦ A0 端口选择信号：8259A有两个端口地址，一个为奇地址，一个为偶地址，奇地址较高，偶地址较低

⑧ IR7～IR0 I/O中断请求信号：与IO设备相连或者说连接从片的INT引脚，接收其中断请求

⑨ CAS2～CAS0 从片选择信号

⑩ SP#/EN# 主片和从片的选择和驱动信号

    /SP//EN：双功能引脚

    （1）输出，低电平有效

        8259A工作在缓冲方式时，该引脚输出低电平控制信号，用来使能系统总线与8259A数据引脚之间的数据缓冲器，使中断向量码能在第二个INTA周期正常从8259A输出。

    （2）输入

        当8259A工作在主从级联方式时，该引脚为输入：

        SP=1，设定8259A为主片；

        SP=0，设定8259A为从片
        
        
```





## 2.编程结构和工作原理



### 组成
```
	控制部分——7个寄存器（八位的寄存器）

    初始化命令字ICW（1-4）
    	功能：决定8259A的工作方式
         通常是在计算机系统启动时在初始程序设置，一旦设定，一般在系统工作过程不再改变。
    操作命令字OCW（1-3）
        功能:在应用程序中设定，动态地控制CPU处理中断的过程
        中断屏蔽寄存器IMR（OCW1）
        保存对中断请求信号IR的屏蔽状态,Di位为1表示IRi中断被屏蔽（禁止）；为0表示允许

	处理部件（8位的寄存器）

    功能：接收和处理从IR0-IR7进入的中断
    - IRR——中断请求寄存器
        保存8个外界中断请求信号IR0～IR7的请求状态
        - Di位为1表示IRi引脚有中断请求；为0表示无请求
        
    - PR——中断优先级裁决器

    - ISR——当前中断服务寄存器
        保存正在被8259A服务着的中断状态
        Di位为1表示IRi中断正在服务中；为0表示没有被服务
```
### 工作原理
（1）接收、处理外设中断申请，决定是否向CPU发中断申请信号。
（2）若CPU响应中断，则在CPU中断响应周期送出中断类型号。

```
中断请求寄存器IRR接收外部中断请求，IRR有8位，分别和引脚IR7-IR0相对应;
接收来自某一引脚的中断请求后，IRR寄存器的对应位置便置1，即对此中断请求锁存;
此后，逻辑电平根据中断屏蔽寄存器IMR中对应位决定时候让此请求通过;
决定IRR中的中断申请是否进入优先级裁决器PR。
    IMR对应位为0，允许中断申请进入优先级裁决器，
    IMR对应位为1，不允许进入，中断申请被IMR屏蔽。
```

```
中断优先级裁决器PR把新进入的中断请求和当前正在处理的中断比较，从而决定哪一个优先级更高
当前中断服务寄存器 ISR 记录CPU正在响应的中断。
- ISR中的某位为1，表示CPU正在响应此级中断，即正在执行此中断源的中断子程；
- ISR中的某位为 0，表示CPU没有或已响应完此级中断，即不在执行此中断源的中断子程

如果进入的中断申请比ISR中记录的中断优先级高，则通过8259A的INT引脚 CPU发出中断请求信号；
如果进入的中断申请不比 ISR 中记录的中断优先级高，     同级或低级，则不向 CPU 发中断请求信号。
```

```
如果CPU的中断允许标志位IF为1,那么CPU执行完当前指令后，就可响应中断，这时，CPU从/INTA端往8259A送出两个负脉冲:


第一个负脉冲到达时，8259A完成三个动作
    - 使IRR锁存功能失效。对IR7-IR0线上的中断请求信号就不再接收；直到第二个负脉冲到达时，才使IRR锁存功能有效
    - 使当前中断服务服务器ISR中的相应位置1，以便中断优先级裁决寄存器以后的工作提供判断依据
    - 使IRR寄存器中的相应位清零（之前接收中断请求时设置的1，现在需要清零）


第二个负脉冲到达时，8259A完成两个动作
    - 将中断类型寄存器中的内容ICW2送到数据总线的D7-D0，CPU将此作为中断类型号
    - 如ICW4中的中断自动结束位为1，则将当前中断服务寄存器ISR的相应位清零
```
## 3.工作方式

### 设置优先级的方式

#### 全嵌套方式
```
最常用的方式

8259A的中断优先权顺序固定不变，从高到低依次为IR0、IR1、IR2、……IR7。0级优先级最高
中断请求后，8259A对当前请求中断中优先权最高的中断IRi予以响应，将其中断类型码送上数据总线，对应ISR的Di位置位，直到中断结束（ISR的Di位复位）。
在ISR的Di位置位期间，禁止再发生同级和低级优先权的中断，但允许高级优先权中断的嵌套。
```
#### 特殊全嵌套方式
```
与全嵌套方式基本相同，只有一点不同：当处理某一级中断时，如果有同级的中断请求，也会给予响应。

特殊全嵌套方式一般用在8259A级联系统中。

一方面，CPU对于优先级别较高的主片的中断输入是允许的；
另一方面，CPU对于来自同一从片的优先级别较高（但对于主片来讲，优先级别是相同的）的中断也是允许、能够响应的。
```
#### 优先级自动循环方式
```
适用场合：系统中多个中断源优先级相等。
初始优先级队列规定为：IR0~IR7。从IR0～IR7引入的中断轮流具有最高优先权。当任何一级中断被处理完，它的优先级别就被改变为最低，而最高优先级分配给该中断的下一级中断。
例如：现正为IR3引入的中断服务，若服务完毕，IR3为最低优先级，IR4有最高优先级，优先级顺序为 IR4,IR5,IR6,…IR2,IR3。
优先级自动循环方式——由OCW2决定
```
#### 优先级特殊循环方式
```
与优先级自动循环方式相比，只有一点不同：初始优先级是由编程决定的。
例如：编程确定IR5为最低优先级，则IR6为最高优先级，初始优先级顺序为IR6,IR7,IR0…IR4,IR5。
优先级特殊循环方式——由OCW2决定
```
### 屏蔽中断源的方式

#### 普通屏蔽方式
```
8259A的每个中断请求输入端都可通过对应屏蔽位的设置而被屏蔽

将OCW1（IMR）的Di位置1，则对应的中断IRi被屏蔽，该中断请求不能从8259A送到CPU。
如果OCW1（IMR）的Di位置0，则允许IRi中断产生。
撤销屏蔽：可以再程序中根据需要设置OCW1（IMR）寄存器的值。
```
#### 特殊屏蔽方式
```
将OCW1（IMR）的Di位置1，对应的中断IRi被屏蔽的同时，使ISR的Di位置0；
开放了其他级别较低的中断。

特殊屏蔽是在中断处理程序中使用的，用了这种方式之后，尽管系统正在处理高级中断，但对外界来讲，只有同级中断被屏蔽，而允许其它任何级别的中断请求。
应用场合： 一个中断服务程序的运行过程中，需要动态地改变系统中的中断优先级结构，即：在中断处理的一部分，禁止低级中断嵌套；而在中断处理的另一部分，允许低级中断嵌套
```
### 结束中断处理的方式
```
中断结束是什么：

CPU响应某级中断后，8259A自动将ISR的对应位置1，如果CPU已执行完中断子程，而ISR中的对应位仍为1,8259A的优先级裁决器仍会据ISR的内容做裁决，从而会屏蔽同级或低级的中断申请。在中断响应后，对 ISR中相应位的清0很重要，  它是8259A认为中断结束的标志。
```
#### 中断自动结束方式
```
适用于系统中只有一片8259A且多个中断不会嵌套的情况。
系统进入中断过程，8259A就自动将当前中断服务寄存器中对应位ISn清除。
方法：ICW4中AEOI位为1。
```
#### 中断一般结束方式
```
配合全嵌套优先权方式使用。
当CPU用输出指令往8259A发出一般中断结束命令（EOI）时，8259A就会把当前中断服务寄存器优先权最高的IS位复位。
方法:在程序中，往8259A的偶地址端口输出一个操作命令字OCW2,OCW2的EOD=1,SL=0,R=0z
```
#### 特殊的中断结束方式
```
配合非全嵌套方式使用。
- CPU在程序中向8259A发送一条特殊中断结束命令（SEOI），这个命令中指出了要清除哪个IS位。
方法：OCW2中的EOI=1,SL=1,R=0

8259A级联方式下，一般采用非自动结束方式。CPU应发出两个中断结束命令，一个送主8259A，用来将其主8259A的ISR寄存器相应位清“0”；另一个送从8259A，用来将其从8259A中的ISR寄存器相应位清“0”。
```
### 连接系统总线的方式

#### 缓冲方式
```
8259A的数据线需加总线驱动器予以驱动。
8259A把 SP#/EN#       引脚作为输出端，输出允许信号（低电平），作为总线驱动器的启动信号。

由ICW4设置
```
#### 非缓冲方式
```
8259A直接与数据总线相连。
- SP#/EN#引脚为输入端。
若8259A级联，由其确定是主片（SP#/EN#       为高）或从片 （SP#/EN# 为低）。

由ICW4设置
```
### 引入中断请求方式

#### 边沿触发方式
```
8259A将中断请求输入端出现的上升沿作为中断请求信号。

- ICW1设置
```
#### 电平触发方式
```
中断请求端出现的高电平是有效的中断请求信号。

- ICW1设置
```
#### 中断查询方式
```
中断查询方式的特点：
    - 8259A不使用INT向CPU发中断请求信号。
    - CPU内部的中断允许触发器复位，禁止外部对CPU的中断请求。
    - CPU要使用软件查询来确认中断源。

查询软件：关中断、送查询命令、读取查询字。
```
## 4.初始化

```
8259A的命令控制字包括两类

初始化命令字和操作命令字

初始化命令字：一般在系统复位后的初始化编程中设置，用于确定8259A的基本工作方式，设置以后一般保持不变

初始化编程：指系统在上电或复位后对可编程器件进行控制字设定的一段程序

操作命令字：是在初始化以后应用程序随时写入的，它实现对8259A的状态，中断方式和过程的动态控制，在工作中可随时写入操作命令字，以修改某些控制方式
```

### 初始化编程
```
8259A开始工作前，必须进行初始化编程；
给8259A写入初始化命令字ICW。
```
### 中断操作编程
```
在8259A工作期间；
可以写入操作命令字OCW将选定的操作传送给8259A，使之按新的要求工作；
还可以读取8259A的信息，以便了解它的工作状态。
```
## 5.初始化命令字
```
8259A有两个连续的端口地址
偶地址较低，奇地址较高

初始化命令字ICW1～ICW4必须按照顺序填写；
- ICW1写入偶地址端口，ICW2～ICW4写入奇地址端口。
```
### ICW1:（*芯片控制初始化命令字*） 
```
- A0=0 偶地址端口
- D7       D6 D5 ：8086系统中不使用，设置1和0都可以
- D4：D4=1，作为OCW1的标识位，用与区分OCW2和OCW3，因为二者也是写到偶地址端口的
- D3：设置中断请求方式。边沿触发/电平触发
- D2：8086系统中不使用，设置1和0都可以
- D1：规定单片或级联方式：SNGL＝1，单片方式；SNGL＝0，级联方式
- D0：8086系统中设置为1，用来指出后面还将要设置ICW4
```
### ICW2（中断类型号初始化命令字）

```
中断类型号的高五位也就是ICW2的高五位，低三位的值则却决于引入中断的引脚序号
 ICW2是任选的；一旦ICW2确定下来，IR0-IR7所对应的八个中断类型号也就确定了
 ICW2高5位影响中断类型码，而中断类型码的低3位由IR0～IR7决定。

例：ICW2为20H，8259A的IR0-IR7的中断类型码为20H,21H,22H…,27H
```
### ICW3（主片/从片初始化命令字）
```
系统中包含多片8259A时，才需要ICW3。
由ICW1的D1位（SNGL）指示，SNGL=0时，才需要设置ICW3。
```
如是主片,则ICW3的格式如下： 


```
IRi＝1说明对应的IRi引脚上接有从片；

IRi＝0则表示IRi没有连接从片
```
如是从片，则ICW3的格式如下： 


```
ID2～ID0编码说明从片INT引脚接到主片哪个IR引脚
```
### ICW4（方式控制初始化命令字）
```
- ICW1的第D0位为1时，才写入ICW4；
16位或32位系统必须设置ICW4。
```

```
- D7-D5:全为0，作为ICW4的标识码

- D4:嵌套方式:

    特殊全嵌套方式（SFNM＝1）
    普通全嵌套方式（SFNM＝0）

- D3:数据线的缓冲方式：

    缓冲方式（BUF＝1）
    非缓冲方式（BUF＝0） 

- D2:

    BUF=0时,M/S#不起作用

    BUF=1时主片/从片选择：

    主片（M/S#=1）
    从片（M/S#=0）

- D1:中断结束方式：

    自动中断结束（AEOI＝1）
    非自动中断结束（AEOI＝0）

- D0:微处理器类型：

    16位或32位系统（mPM＝1）
    8位系统8080/8085（mPM＝0）
```
### 初始化流程
```
8259A在进入工作之前，必须先使用初始化命令字将每片8259A进行初始化。8259A的初始化流程应该遵循固定的次序

① ICW1写入偶端口，ICW2～ICW4写入奇端口；

② ICW1～ICW4的设置次序固定；

③ ICW1和ICW2必须设置，ICW3和ICW4非必须 ；16位和32位系统中ICW4必须设置，多8259A级联时，ICW3要设置

④ 在级联时，主片和从片各设置ICW3；注意其ICW3的格式并不相同
```
## 6.操作命令字
```
操作命令字是在应用程序中设置的

设置次序没用要求

- OCW1写入奇地址端口

- OCW2 OCW3写入偶地址端口
```
### OCW1（中断屏蔽操作命令字）

```
中断屏蔽操作命令字：内容写入中断屏蔽寄存器IMR
- Di＝Mi对应IRi为1禁止IRi中断；为0允许IRi中断。各位互相独立。
```
### OCW2（优先级循环方式和中断结束方式操作命令字）

```
- R、SL和EOI配合使用产生中断结束EOI命令和改变优先权顺序
- D4D3=00  为OCW2的标志位
- L2～L0的3位编码指定IR引脚 
```


### OCW3（状态操作命令字）
```
（1）设置和撤销特殊屏蔽方式

（2）设置中断查询方式

（3）设置对内部寄存器的读出命令
```

```
- ESMM称为SMM的允许位
    - SMM为特殊屏蔽模式位
    - ESMM为特殊屏蔽模式允许位
```
- P：查询方式位
```
```
- RR RIS
```
```

## 7.使用举例

